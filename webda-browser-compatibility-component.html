<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<script type="text/javascript" src="../../bower_components/webcomponentsjs/webcomponents-loader.js"></script>
<script type="text/javascript" src="../../bower_components/ua-parser-js/src/ua-parser.js"></script>

<dom-module id="webda-browser-compatibility-component">
  <template>
    <style>
      :host {
        display: block;
      }
      paper-toast {
         width: 100%;
         display: flex;
         justify-content: space-between;
         align-items: center;
         background-color: DarkOliveGreen;
       }
    </style>
    <paper-toast text="[[warningMsg]]" duration="0" id="toast">
      <paper-icon-button opened on-tap="_closeToast" icon="close" style="color: white;">
      </paper-icon-button>
    </paper-toast>

  </template>

  <script>
    /**
     * `webda-browser-compatibility-component`
     * display paper-toast if the client-browser doesn&#39;t match defined requirements
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class WebdaBrowserCompatibilityComponent extends Polymer.Element {
      static get is() { return 'webda-browser-compatibility-component'; }
      static get properties() {
        return {
          browser: {
            type: String
          },
          warningMsg: {
            type: String,
            value: 'your browser is not supported'
          },
          detectedBrowser: {
            type: Object,
            notify: true
          },
          detectedVersion: {
            type: Number
          },
          bannedAgents : {
            type: Object,
            value : [
              {name: "Chrome", untilVersion: "59.0.3071.114"},
              {name: "MSIE" , untilVersion: "42"}
            ]
          },
          minAgents : {
            type: Object,
            value : [
              {name: "Chrome", minVersion: "59.0.3071.116"},
              {name: "Firefox" , minVersion: "42"},
            ]
          },
          compareResult: {
            type: Number
          }
        };
      }
        _closeToast() {
          this.$.toast.close();
        }


        ready () {
          super.ready();
          this._browserVersionAnalysis();
        }

        //adapted from Alexey Bass

        _versionCompare (left, right) {
            if (typeof(left) != 'string' || typeof(right) != 'string') {
                return false;
            }

            var a = left.split('.')
            ,   b = right.split('.')
            ,   i = 0, len = Math.max(a.length, b.length);

            for (; i < len; i++) {
                if ((a[i] && !b[i] && parseInt(a[i]) > 0) || (parseInt(a[i]) > parseInt(b[i]))) {
                    return 1;
                }
                else if ((b[i] && !a[i] && parseInt(b[i]) > 0) || (parseInt(a[i]) < parseInt(b[i]))) {
                    return -1;
                }
            }

            return 0;
        }

        _browserVersionAnalysis () {

          this.detectedBrowser = new UAParser().getBrowser();

          for (var j in this.bannedAgents) {

            if (this.bannedAgents[j].name === this.detectedBrowser.name
              && this._versionCompare(this.detectedBrowser.version, this.bannedAgents[j].untilVersion) < 0) {

              this.$.toast.show(
                {text: this.warningMsg}
              );
              return;
            }
          }

          for (var k in this.minAgents) {
            if (this.minAgents[k].name === this.detectedBrowser.name
            && this._versionCompare(this.detectedBrowser.version, this.minAgents[k].minVersion) >= 0) {
              return;
            }
          }

          this.$.toast.show(
            {text: this.warningMsg}
          );
        }

      }


    window.customElements.define(WebdaBrowserCompatibilityComponent.is, WebdaBrowserCompatibilityComponent);
  </script>
</dom-module>
